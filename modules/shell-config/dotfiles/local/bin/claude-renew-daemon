#!/usr/bin/env bash

set -u

RENEW_WINDOW_SECONDS=${RENEW_WINDOW_SECONDS:-120}
CHECK_INTERVAL_SECONDS=${CHECK_INTERVAL_SECONDS:-60}
RESET_SECONDS=${RESET_SECONDS:-18000}
LAST_ACTIVITY_FILE="${LAST_ACTIVITY_FILE:-$HOME/.claude-last-activity}"

log() {
  printf '[%s] %s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$*"
}

get_seconds_until_reset() {
  if ! command -v ccusage >/dev/null 2>&1; then
    return 1
  fi
  if ! command -v jq >/dev/null 2>&1; then
    return 1
  fi

  local json end_time end_epoch now remaining
  json=$(ccusage blocks --json --active 2>/dev/null) || return 1
  end_time=$(printf '%s' "$json" | jq -r '.blocks[0].endTime // empty') || return 1

  if [ -z "$end_time" ]; then
    printf 'none\n'
    return 0
  fi

  end_epoch=$(date -d "$end_time" +%s 2>/dev/null) || return 1
  now=$(date +%s)
  remaining=$((end_epoch - now))
  if [ "$remaining" -lt 0 ]; then
    remaining=0
  fi

  printf '%s\n' "$remaining"
}

should_renew_fallback() {
  local now last_activity elapsed
  now=$(date +%s)

  if [ ! -f "$LAST_ACTIVITY_FILE" ]; then
    return 0
  fi

  last_activity=$(cat "$LAST_ACTIVITY_FILE" 2>/dev/null || true)
  if [ -z "$last_activity" ]; then
    return 0
  fi

  elapsed=$((now - last_activity))
  if [ "$elapsed" -ge "$RESET_SECONDS" ]; then
    return 0
  fi

  return 1
}

start_claude_session() {
  if ! command -v claude >/dev/null 2>&1; then
    log "claude not found; skipping renew"
    return 1
  fi

  log "Starting Claude session to renew block"
  if printf 'hi\n' | claude >/dev/null 2>&1; then
    date +%s > "$LAST_ACTIVITY_FILE"
    log "Renewal complete"
    return 0
  fi

  log "Renewal failed"
  return 1
}

log "Claude renew daemon started"

while true; do
  seconds_until_reset=$(get_seconds_until_reset 2>/dev/null) || seconds_until_reset=""

  if [ "$seconds_until_reset" = "none" ] || [ -z "$seconds_until_reset" ]; then
    if should_renew_fallback; then
      start_claude_session
      sleep "$CHECK_INTERVAL_SECONDS"
      continue
    fi

    sleep "$CHECK_INTERVAL_SECONDS"
    continue
  fi

  if [ "$seconds_until_reset" -le "$RENEW_WINDOW_SECONDS" ]; then
    log "Reset in ${seconds_until_reset}s; waiting to renew"
    sleep "$((seconds_until_reset + 5))"
    start_claude_session
    sleep "$CHECK_INTERVAL_SECONDS"
    continue
  fi

  sleep "$CHECK_INTERVAL_SECONDS"
done
